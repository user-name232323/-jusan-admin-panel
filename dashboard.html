<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Административная панель</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
    }
    .header {
      background-color: #ff6600;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .admin-text {
      font-size: 24px;
      font-weight: bold;
    }
    .user-panel {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-avatar {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .user-name {
      font-weight: 500;
    }
    main {
      padding: 40px;
    }
    h2 {
      color: #333;
      margin-bottom: 10px;
    }
    .departments-scroll {
      overflow-x: auto;
      padding: 10px 0;
      margin-bottom: 20px;
    }
    .department-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      width: max-content;
    }
    .department-button {
      background-color: #ff7f00;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      white-space: nowrap;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .department-button:hover {
      background-color: #e06700;
    }
    .active-department {
      background-color: red;
    }
    #filter-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    #filter-bar select,
    #filter-bar input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #filter-bar button {
      background-color: #ff6600;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    #requests-container {
      background: white;
      border-radius: 10px;
      padding: 20px 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    #requests-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #requests-list li {
      padding: 15px;
      border-bottom: 1px solid #ddd;
    }
    #requests-list li:last-child {
      border-bottom: none;
    }
    .request-id {
      font-weight: bold;
      color: #ff6600;
    }
    .request-subject {
      font-weight: 600;
      margin-right: 5px;
    }
    .request-desc {
      color: #555;
    }
  </style>
</head>
<body>
<header class="header">
  <div class="admin-text">Административная панель</div>
  <div class="user-panel">
    <img src="logo_admin4.png" alt="User Avatar" class="user-avatar" onclick="logout()" title="Выйти">
    <span class="user-name">Администратор</span>
  </div>
</header>

<main>
  <h2>Добро пожаловать в панель администратора</h2>

  <div class="departments-scroll">
    <div class="department-buttons">
      <button class="department-button active-department">Отдел развития и подключений</button>
      <button class="department-button">Коммерческий блок</button>
      <button class="department-button">Департамент маркетинга</button>
      <button class="department-button">Юридический департамент</button>
      <button class="department-button">Департамент эксплуатации</button>
      <button class="department-button">Call центр</button>
      <button class="department-button">Один менеджер</button>
      <button class="department-button">Департамент обслуживания клиентов</button>
      <button class="department-button">Бухгалтерия</button>
      <button class="department-button">IT department</button>
      <button class="department-button">[Пусто]</button>
      <button class="department-button">[Пусто]</button>
    </div>
  </div>

  <div id="filter-bar">
    <select id="filter-city"><option value="">Город</option></select>
    <select id="filter-street"><option value="">Улица</option></select>
    <select id="filter-house"><option value="">Дом</option></select>
    <select id="filter-status"><option value="">Статус</option><option>Новая</option></select>
    <input type="text" id="filter-search" placeholder="Поиск...">
    <button onclick="applyFilters()">Применить</button>
  </div>

  <div id="requests-container">
    <h3>Заявки пользователей:</h3>
    <ul id="requests-list">
      <li>Загрузка заявок...</li>
    </ul>
  </div>
</main>

<script>
  let allRequests = [];

  function extractCity(description) {
    const match = description.match(/адрес:\s*([^\s,]+)/i);
    return match ? match[1].trim() : "";
  }

  function extractStreet(description) {
    const match = description.match(/адрес:.*?,\s*([^,]+),/i);
    return match ? match[1].trim() : "";
  }

  function extractHouse(description) {
    const match = description.match(/дом\s+([^,.\n]+)/i);
    return match ? match[1].trim() : "";
  }

  async function fetchRequests() {
    try {
      const response = await fetch("https://jusik-servak-bd.onrender.com/requests");
      const data = await response.json();
      allRequests = data;
      populateFilters(data);
      renderRequests(data);
    } catch (err) {
      document.getElementById('requests-list').innerHTML = "<li>Ошибка загрузки</li>";
      console.error("Ошибка загрузки заявок:", err);
    }
  }

  function populateFilters(data) {
    const cities = new Set();
    const streets = new Set();
    const houses = new Set();

    data.forEach(req => {
      const desc = req.description || "";
      const city = extractCity(desc);
      const street = extractStreet(desc);
      const house = extractHouse(desc);
      if (city) cities.add(city);
      if (street) streets.add(street);
      if (house) houses.add(house);
    });

    document.getElementById("filter-city").innerHTML =
      '<option value="">Город</option>' + [...cities].map(c => `<option>${c}</option>`).join("");
    document.getElementById("filter-street").innerHTML =
      '<option value="">Улица</option>' + [...streets].map(s => `<option>${s}</option>`).join("");
    document.getElementById("filter-house").innerHTML =
      '<option value="">Дом</option>' + [...houses].map(h => `<option>${h}</option>`).join("");
  }

  function applyFilters() {
    const city = document.getElementById("filter-city").value.toLowerCase();
    const street = document.getElementById("filter-street").value.toLowerCase();
    const house = document.getElementById("filter-house").value.toLowerCase();
    const status = document.getElementById("filter-status").value.toLowerCase();
    const search = document.getElementById("filter-search").value.toLowerCase();

    const filtered = allRequests.filter(req => {
      const desc = (req.description || "").toLowerCase();
      const stat = (req.status || "").toLowerCase();

      const matchCity = extractCity(desc).toLowerCase();
      const matchStreet = extractStreet(desc).toLowerCase();
      const matchHouse = extractHouse(desc).toLowerCase();

      return (!city || matchCity === city) &&
             (!street || matchStreet === street) &&
             (!house || matchHouse === house) &&
             (!status || stat === status) &&
             (!search || desc.includes(search) || (req.subject || "").toLowerCase().includes(search));
    });

    renderRequests(filtered);
  }

  function renderRequests(requests) {
    const list = document.getElementById('requests-list');
    list.innerHTML = "";

    if (requests.length === 0) {
      list.innerHTML = "<li>Нет заявок</li>";
      return;
    }

    requests.forEach(req => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <span class="request-id">#${req.id}</span>
          <span class="request-subject">${req.subject || ""}</span> —
          <span class="request-desc">${req.description || "(без описания)"}</span><br>
          <b>Статус:</b> ${req.status}
        </div>
        <div style="margin-top: 8px;">
          <button onclick="updateStatus(${req.id}, 2)" style="margin-right: 8px;">Принять в работу</button>
          <button onclick="updateStatus(${req.id}, 3)" style="background-color: #ccc;">Отклонить</button>
        </div>
      `;
      list.appendChild(li);
    });
  }

  async function updateStatus(requestId, status_id) {
    try {
      const response = await fetch("https://jusik-servak-bd.onrender.com/update_status", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ request_id: requestId, status_id: status_id })
      });

      const result = await response.json();
      if (response.ok && result.success) {
        fetchRequests(); // Обновим список заявок
      } else {
        alert(result.message || "Ошибка при обновлении статуса");
      }
    } catch (err) {
      console.error("Ошибка обновления статуса:", err);
      alert("Ошибка при подключении к серверу");
    }
  }

  function logout() {
    localStorage.removeItem("admin_logged_in");
    window.location.href = "index.html";
  }

  if (localStorage.getItem("admin_logged_in") !== "true") {
    window.location.href = "index.html";
  } else {
    fetchRequests();
    setInterval(fetchRequests, 10000); // обновлять заявки каждые 10 секунд
  }
</script>

</body>
</html>
