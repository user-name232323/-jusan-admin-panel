<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Административная панель</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
    }
    .header {
      background-color: #ff6600;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .admin-text {
      font-size: 24px;
      font-weight: bold;
    }
    .user-panel {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-avatar {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .user-name {
      font-weight: 500;
    }
    main {
      padding: 40px;
    }
    h2 {
      color: #333;
      margin-bottom: 10px;
    }
    .departments-scroll {
      overflow-x: auto;
      padding: 10px 0;
      margin-bottom: 20px;
    }
    .department-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      width: max-content;
    }
    .department-button {
      background-color: #ff7f00;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      white-space: nowrap;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .department-button:hover {
      background-color: #e06700;
    }
    .active-department {
      background-color: red;
    }
    #filter-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    #filter-bar select,
    #filter-bar input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #filter-bar button {
      background-color: #ff6600;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    #requests-container {
      background: white;
      border-radius: 10px;
      padding: 20px 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    #requests-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #requests-list li {
      padding: 15px;
      border-bottom: 1px solid #ddd;
    }
    #requests-list li:last-child {
      border-bottom: none;
    }
    .request-id {
      font-weight: bold;
      color: #ff6600;
    }
    .request-subject {
      font-weight: 600;
      margin-right: 5px;
    }
    .request-desc {
      color: #555;
    }

    /* Стиль для блока сообщений */
    #message-box {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
      font-weight: 600;
      user-select: none;
    }
  </style>
</head>
<body>
<header class="header">
  <div class="admin-text">Административная панель</div>
  <div class="user-panel">
    <img src="logo_admin4.png" alt="User Avatar" class="user-avatar" onclick="logout()" title="Выйти" />
    <span class="user-name">Администратор</span>
  </div>
</header>

<main>
  <h2>Добро пожаловать в панель администратора</h2>

  <div class="departments-scroll">
    <div class="department-buttons">
      <button class="department-button active-department">Отдел развития и подключений</button>
      <button class="department-button">Коммерческий блок</button>
      <button class="department-button">Департамент маркетинга</button>
      <button class="department-button">Юридический департамент</button>
      <button class="department-button">Департамент эксплуатации</button>
      <button class="department-button">Call центр</button>
      <button class="department-button">Один менеджер</button>
      <button class="department-button">Департамент обслуживания клиентов</button>
      <button class="department-button">Бухгалтерия</button>
      <button class="department-button">IT department</button>
      <button class="department-button">[Пусто]</button>
      <button class="department-button">[Пусто]</button>
    </div>
  </div>

  <div id="filter-bar">
    <select id="filter-city"><option value="">Город</option></select>
    <select id="filter-street"><option value="">Улица</option></select>
    <select id="filter-house"><option value="">Дом</option></select>
    <select id="filter-status">
      <option value="">Статус</option>
      <option value="1">В ожидании</option>
      <option value="2">В работе</option>
      <option value="3">Нет тех возможности</option>
      <option value="4">Есть тех возможность</option>
    </select>
    <input type="text" id="filter-search" placeholder="Поиск..." />
    <button onclick="applyFilters()">Применить</button>
  </div>

  <div id="requests-container">
    <h3>Заявки пользователей:</h3>
    <ul id="requests-list">
      <li>Загрузка заявок...</li>
    </ul>
  </div>
</main>

<!-- Блок для сообщений -->
<div id="message-box"></div>

<script>
  let allRequests = [];

  function extractCity(description) {
    const match = description.match(/адрес:\s*([^\s,]+)/i);
    return match ? match[1].trim() : "";
  }

  function extractStreet(description) {
    const match = description.match(/адрес:.*?,\s*([^,]+),/i);
    return match ? match[1].trim() : "";
  }

  function extractHouse(description) {
    const match = description.match(/дом\s+([^,.\n]+)/i);
    return match ? match[1].trim() : "";
  }

  function getStatusNameById(id) {
    const names = {
      1: "В ожидании",
      2: "В работе",
      3: "Нет тех возможности",
      4: "Есть тех возможность"
    };
    return names[id] || "Неизвестный статус";
  }

  async function fetchRequests() {
    try {
      const response = await fetch("https://jusik-servak-bd.onrender.com/requests");
      const data = await response.json();
      allRequests = data;
      populateFilters(data);
      renderRequests(data);
    } catch (err) {
      document.getElementById('requests-list').innerHTML = "<li>Ошибка загрузки</li>";
      console.error("Ошибка загрузки заявок:", err);
    }
  }

  function populateFilters(data) {
    const cities = new Set();
    const streets = new Set();
    const houses = new Set();

    data.forEach(req => {
      const desc = req.description || "";
      const city = extractCity(desc);
      const street = extractStreet(desc);
      const house = extractHouse(desc);
      if (city) cities.add(city);
      if (street) streets.add(street);
      if (house) houses.add(house);
    });

    document.getElementById("filter-city").innerHTML =
      '<option value="">Город</option>' + [...cities].map(c => `<option>${c}</option>`).join("");
    document.getElementById("filter-street").innerHTML =
      '<option value="">Улица</option>' + [...streets].map(s => `<option>${s}</option>`).join("");
    document.getElementById("filter-house").innerHTML =
      '<option value="">Дом</option>' + [...houses].map(h => `<option>${h}</option>`).join("");
  }

  function applyFilters() {
    const city = document.getElementById("filter-city").value.toLowerCase();
    const street = document.getElementById("filter-street").value.toLowerCase();
    const house = document.getElementById("filter-house").value.toLowerCase();
    const status = document.getElementById("filter-status").value;
    const search = document.getElementById("filter-search").value.toLowerCase();

    const filtered = allRequests.filter(req => {
      const desc = (req.description || "").toLowerCase();
      const stat = req.status ? req.status.toString() : "";

      const matchCity = extractCity(desc).toLowerCase();
      const matchStreet = extractStreet(desc).toLowerCase();
      const matchHouse = extractHouse(desc).toLowerCase();

      return (!city || matchCity === city) &&
             (!street || matchStreet === street) &&
             (!house || matchHouse === house) &&
             (!status || stat === status) &&
             (!search || desc.includes(search) || (req.subject || "").toLowerCase().includes(search));
    });

    renderRequests(filtered);
  }

  function showMessage(text) {
    const box = document.getElementById("message-box");
    box.textContent = text;
    box.style.display = "block";
    setTimeout(() => {
      box.style.display = "none";
    }, 3000);
  }

  async function updateStatus(requestId, status_id, btn) {
    try {
      btn.disabled = true;
      btn.textContent = "Обновляется...";
      const response = await fetch("https://jusik-servak-bd.onrender.com/update_status", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ request_id: requestId, status_id: status_id })
      });

      const result = await response.json();
      if (response.ok && result.success) {
        showMessage(`Заявка #${requestId} обновлена успешно.`);
        // Навсегда блокируем кнопку и меняем текст в зависимости от статуса
        if (status_id === 2) {
          btn.textContent = "В работе";
        } else if (status_id === 3) {
          btn.textContent = "Нет тех. возможности";
        } else if (status_id === 4) {
          btn.textContent = "Есть тех. возможность";
        } else {
          btn.textContent = "Обновлено";
        }
        btn.disabled = true;
      } else {
        alert(result.message || "Ошибка при обновлении статуса");
        btn.disabled = false;
        btn.textContent = "Принять в работу";
      }
    } catch (err) {
      console.error("Ошибка обновления статуса:", err);
      alert("Ошибка при подключении к серверу");
      btn.disabled = false;
      btn.textContent = "Принять в работу";
    }
  }

  function disableAndUpdate(button, requestId, statusId) {
    updateStatus(requestId, statusId, button);
  }

  function renderRequests(requests) {
    const list = document.getElementById('requests-list');
    list.innerHTML = "";

    if (requests.length === 0) {
      list.innerHTML = "<li>Нет заявок</li>";
      return;
    }

    requests.forEach(req => {
      const statusName = getStatusNameById(req.status);
      const li = document.createElement('li');

      // Проверяем, если статус "В работе" (2) — блокируем кнопку "Принять в работу"
      const isInWork = req.status === 2;

      li.innerHTML = `
        <div>
          <span class="request-id">#${req.id}</span>
          <span class="request-subject">${req.subject || ""}</span> —
          <span class="request-desc">${req.description || "(без описания)"}</span><br>
          <b>Статус:</b> ${statusName}
        </div>
        <div style="margin-top: 8px;">
          <button
            ${isInWork ? "disabled" : ""}
            style="margin-right: 8px;"
            onclick="disableAndUpdate(this, ${req.id}, 2)"
          >
            ${isInWork ? "В работе" : "Принять в работу"}
          </button>
          <button onclick="disableAndUpdate(this, ${req.id}, 3)" style="background-color: #ccc;">Нет технической возможности</button>
        </div>
      `;

      list.appendChild(li);
    });
  }

  function logout() {
    localStorage.removeItem("admin_logged_in");
    window.location.href = "index.html";
  }

  if (localStorage.getItem("admin_logged_in") !== "true") {
    window.location.href = "index.html";
  } else {
    fetchRequests();
    setInterval(fetchRequests, 10000);
  }
</script>

</body>
</html>
